# Declares the size of a request's body. This is mainly used to allow large blueprints to be uploaded.
client_max_body_size 50m;

# Upstream for Cloudify's UI. WEBUI_ADDR is replaced with the WEBUI Container's IP address when the Nginx container starts.
upstream cloudify-ui {
  server webui:9001;
}

# Upstream for Cloudify's Rest Service. RESTSERVICE_ADDR is replaced with the RESTSERVICE Container's IP address when the Nginx container starts.
upstream cloudify-rest {
  server restservice:8100;
}

# Upstream for Cloudify's File Server. Since Nginx is serving the fileserver by itself, it's always localhost. For other containers to by able to access the file server, they will have to configure Nginx's IP.
upstream cloudify-resources {
  server localhost:53229;
}

# REST and UI server.
server {

  # Overcoming the renowned http://stackoverflow.com/questions/19238122/nginx-with-ubuntu-and-rails-on-digital-ocean
  types_hash_max_size 4096;
  listen              *:80;
  server_name         _;

  access_log          /var/log/cloudify/nginx/cloudify.access.log;
  error_log           /var/log/cloudify/nginx/cloudify.error.log;

  # Statically serves grafana for the UI.
  location /grafana {
    root /opt/cloudify-ui;
    index  index.html  index.htm;
  }

  # Statically serves the UI's front end.
  location / {
    root  /opt/cloudify-ui;
    index  index.html  index.htm;
  }

  # Serves the UI's backend (backed by the cloudify-ui upstream).
  location /backend {
    proxy_pass         http://cloudify-ui;
    proxy_read_timeout 90;
    proxy_buffering    off;

    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Scheme         $scheme;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header   Host             $http_host;
  }

  # Serves the Rest Service (backed by the cloudify-rest upstream).
  location ~ ^/(blueprints|executions|deployments|nodes|events|search|status|provider|api|node-instances|version|evaluate|deployment-modifications) {
    proxy_pass         http://cloudify-rest;
    proxy_redirect     off;

    proxy_set_header   Host             $host;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
  }

  # Serves the File Server (backed by the cloudify-resources upstream).
  location ~ ^/resources {
    rewrite            /resources/(.*) /$1 break;
    proxy_pass         http://cloudify-resources;
    proxy_redirect     off;

    proxy_set_header   Host             $http_host;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
  }

}

# File server. /fileserver is a volume that is mapped to a data container by default.
server {
  listen        *:53229;
  server_name   fileserver;

  access_log    /var/log/cloudify/nginx/cloudify-files.log;
  location / {
    root              /opt/manager/resources;
    autoindex on;
    allow             all;
    deny              all;
  }
}
